<%@ WebHandler Language="VB" Class="GetExistingDataHandler" %>

Imports System.Web
Imports System.Web.Script.Serialization
Imports System.IO
Imports System.Data
Imports System.Globalization
Imports ARAworkloadScheduler

Public Class GetExistingDataHandler
    Implements IHttpHandler

    Public Sub ProcessRequest(ByVal context As HttpContext) Implements IHttpHandler.ProcessRequest
        context.Response.ContentType = "application/json"

        Try
            ' Read JSON from request body
            Dim requestBody As String = New StreamReader(context.Request.InputStream).ReadToEnd()
            Dim serializer As New JavaScriptSerializer()
            Dim data As Dictionary(Of String, String) = serializer.Deserialize(Of Dictionary(Of String, String))(requestBody)

            Dim userId As String = data("userId")
            Dim startDate As String = data("startDate")
            Dim endDate As String = data("endDate")

            ' Initialize logger and data access
            Dim detector As New EnvironmentDetector()
            Dim logger As New SchedulerLogger(detector.GetEnvironment(), detector.GetLogPath(), "Handler")
            logger.LogInfo($"GetExistingDataHandler called: userId={userId}, startDate={startDate}, endDate={endDate}")

            Dim dataAccess As New DataAccess("Handler")

            ' Parse dates (format: dd/mm/yyyy)
            Dim parsedStartDate As DateTime = DateTime.ParseExact(startDate, "dd/MM/yyyy", CultureInfo.InvariantCulture)
            Dim parsedEndDate As DateTime = DateTime.ParseExact(endDate, "dd/MM/yyyy", CultureInfo.InvariantCulture)

            logger.LogInfo($"Parsed dates: {parsedStartDate:yyyy-MM-dd} to {parsedEndDate:yyyy-MM-dd}")

            ' Get Shift Hours data
            Dim shiftHoursList As New List(Of Object)
            Dim shData = dataAccess.GetShiftHoursByUserAndDateRange(userId, parsedStartDate, parsedEndDate)
            logger.LogInfo($"Found {shData.Rows.Count} shift hours records")

            For Each row As DataRow In shData.Rows
                shiftHoursList.Add(New With {
                    .date = CDate(row("date")).ToString("dd/MM/yyyy"),
                    .startTime = row("startTime").ToString(),
                    .endTime = row("endTime").ToString()
                })
            Next

            ' Get ARA Availability data
            Dim araAvailabilityList As New List(Of Object)
            Dim araData = dataAccess.GetARAAvailabilityByUserAndDateRange(userId, parsedStartDate, parsedEndDate)
            logger.LogInfo($"Found {araData.Rows.Count} ARA availability records")

            For Each row As DataRow In araData.Rows
                araAvailabilityList.Add(New With {
                    .date = CDate(row("date")).ToString("dd/MM/yyyy"),
                    .startTime = row("startTime").ToString(),
                    .endTime = row("endTime").ToString()
                })
            Next

            logger.LogInfo($"Returning {shiftHoursList.Count} SH + {araAvailabilityList.Count} AA records")

            ' Return JSON response
            Dim result = New With {
                .shiftHours = shiftHoursList,
                .araAvailability = araAvailabilityList
            }

            context.Response.Write(serializer.Serialize(result))

        Catch ex As Exception
            Dim detector As New EnvironmentDetector()
            Dim logger As New SchedulerLogger(detector.GetEnvironment(), detector.GetLogPath(), "Handler")
            logger.LogError($"GetExistingDataHandler error: {ex.Message}")
            logger.LogError($"Stack trace: {ex.StackTrace}")

            Dim errorResult = New With {
                .error = True,
                .message = "Error loading data: " & ex.Message
            }

            Dim serializer As New JavaScriptSerializer()
            context.Response.Write(serializer.Serialize(errorResult))
        End Try
    End Sub

    Public ReadOnly Property IsReusable() As Boolean Implements IHttpHandler.IsReusable
        Get
            Return False
        End Get
    End Property

End Class
